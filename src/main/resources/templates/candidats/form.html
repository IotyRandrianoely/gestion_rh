<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title th:text="${candidat.id == null ? 'Nouvelle candidature' : 'Modifier candidature'}"></title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select, textarea { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        textarea { height: 100px; resize: vertical; }
        .btn { padding: 10px 20px; margin: 5px; text-decoration: none; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .btn-success { background-color: #28a745; }
        .btn-secondary { background-color: #6c757d; }
        .required { color: red; }
        .alert { padding: 15px; margin: 15px 0; border-radius: 4px; }
        .alert-error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .alert-success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-warning { background-color: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .selected-annonce { background-color: #e7f3ff; padding: 15px; border-radius: 5px; margin-bottom: 20px; border-left: 4px solid #007bff; }
        .eligibility-warning { background-color: #fff3cd; color: #856404; border: 1px solid #ffeaa7; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
        .criteria-info { background-color: #e1ecf4; color: #0c5460; border: 1px solid #bee5eb; padding: 10px; border-radius: 3px; margin-top: 10px; font-size: 0.9em; }
        .file-type-tabs { display: flex; margin-bottom: 10px; }
        .file-type-tab { padding: 8px 16px; background-color: #f8f9fa; border: 1px solid #ddd; cursor: pointer; margin-right: 2px; border-radius: 4px 4px 0 0; }
        .file-type-tab.active { background-color: #007bff; color: white; }
        .file-type-content { display: none; }
        .file-type-content.active { display: block; }
        .file-upload input[type="file"] { margin-bottom: 10px; }
        .file-info { margin-top: 10px; padding: 10px; background-color: #f8f9fa; border-radius: 3px; font-size: 0.9em; }
        .current-cv { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; padding: 10px; border-radius: 3px; margin-bottom: 10px; }
    </style>
</head>
<body>
    <h2 th:text="${candidat.id == null ? 'Nouvelle candidature' : 'Modifier candidature'}"></h2>

    <!-- Messages d'erreur et de succ√®s -->
    <div th:if="${error}" class="alert" 
         th:classappend="${notEligible} ? 'alert-warning' : 'alert-error'" 
         th:utext="${error}"></div>
    <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>

    <!-- Affichage de l'annonce s√©lectionn√©e -->
    <div th:if="${selectedAnnonce}" class="selected-annonce">
        <h3>üéØ Candidature pour l'annonce :</h3>
        <p><strong>Profil :</strong> <span th:text="${selectedAnnonce.profil}"></span></p>
        <p><strong>Description :</strong> <span th:text="${selectedAnnonce.description}"></span></p>
    </div>

    <form th:action="@{/candidats/postuler}" method="post" th:object="${candidat}" enctype="multipart/form-data">
        <input type="hidden" th:field="*{id}" />

        <!-- Si une annonce est pr√©-s√©lectionn√©e, on la cache et la pr√©-remplit -->
        <div class="form-group" th:if="${selectedAnnonce == null}">
            <label for="annonce">Annonce <span class="required">*</span></label>
            <select name="annonce.id" id="annonce" required onchange="showAnnonceCriteria()">
                <option value="">-- S√©lectionner une annonce --</option>
                <option th:each="a : ${annonces}"
                        th:value="${a.id}"
                        th:selected="${selectedAnnonceId != null and selectedAnnonceId == a.id}"
                        th:text="${a.profil + ' - ' + a.description}"
                        th:data-experience="${a.critereRech != null ? a.critereRech.anneesExperience : ''}"
                        th:data-age="${a.critereRech != null ? a.critereRech.age : ''}"
                        th:data-diplome="${a.critereRech != null and a.critereRech.diplome != null ? a.critereRech.diplome.nomDiplome : ''}"
                        th:data-filiere="${a.critereRech != null and a.critereRech.filiere != null ? a.critereRech.filiere.nomFiliere : ''}">
                </option>
            </select>
            
            <!-- Affichage des crit√®res de l'annonce s√©lectionn√©e -->
            <div id="criteria-info" class="criteria-info" style="display: none;">
                <strong>üìã Crit√®res requis pour cette annonce :</strong>
                <ul id="criteria-list"></ul>
            </div>
        </div>

        <!-- Champ cach√© pour l'annonce pr√©-s√©lectionn√©e -->
        <input type="hidden" name="annonce.id" th:value="${selectedAnnonce != null ? selectedAnnonce.id : selectedAnnonceId}" th:if="${selectedAnnonce != null or selectedAnnonceId != null}"/>

        <div class="form-group">
            <label for="nom">Nom <span class="required">*</span></label>
            <input type="text" th:field="*{nom}" id="nom" required maxlength="40"/>
        </div>

        <div class="form-group">
            <label for="prenom">Pr√©nom <span class="required">*</span></label>
            <input type="text" th:field="*{prenom}" id="prenom" required maxlength="40"/>
        </div>

        <div class="form-group">
            <label for="email">Email <span class="required">*</span></label>
            <input type="email" th:field="*{email}" id="email" required maxlength="40"/>
        </div>

        <div class="form-group">
            <label for="age">√Çge <span class="required">*</span></label>
            <input type="number" th:field="*{age}" id="age" required min="16" max="70" onchange="checkEligibility()"/>
        </div>

        <div class="form-group">
            <label for="genre">Genre <span class="required">*</span></label>
            <select th:field="*{genre}" id="genre" required>
                <option value="">-- S√©lectionner --</option>
                <option value="1">Homme</option>
                <option value="2">Femme</option>
            </select>
        </div>

        <!-- *** NOUVEAU CHAMP DIPLOME *** -->
        <div class="form-group">
            <label for="diplome">Dipl√¥me <span class="required">*</span></label>
            <select th:field="*{diplome.id}" id="diplome" required>
                <option value="">-- S√©lectionner un dipl√¥me --</option>
                <option th:each="d : ${diplomes}"
                        th:value="${d.id}"
                        th:text="${d.nomDiplome}">
                </option>
            </select>
        </div>

        <div class="form-group">
            <label for="adresse">Adresse</label>
            <input type="text" th:field="*{adresse}" id="adresse" maxlength="60"/>
        </div>

        <div class="form-group">
            <label for="anneesExperience">Ann√©es d'exp√©rience <span class="required">*</span></label>
            <input type="number" th:field="*{anneesExperience}" id="anneesExperience" required min="0" max="50" onchange="checkEligibility()"/>
        </div>

        <!-- Zone d'alerte d'√©ligibilit√© en temps r√©el -->
        <div id="eligibility-warning" class="eligibility-warning" style="display: none;">
            <strong>‚ö†Ô∏è Attention :</strong> <span id="eligibility-message"></span>
        </div>

        <div class="form-group">
            <label for="lettreMotivation">Lettre de motivation</label>
            <textarea th:field="*{lettreMotivation}" id="lettreMotivation" maxlength="300"></textarea>
        </div>

        <!-- Section Upload CV/Document avec support des images -->
        <div class="form-group">
            <label>CV ou Portfolio</label>
            
            <!-- Affichage du CV actuel si existe -->
            <div th:if="${candidat.cv != null and not #strings.isEmpty(candidat.cv)}" class="current-cv">
                üìÑ CV/Document actuel : <strong th:text="${candidat.cv}"></strong>
                <br/>
                <a th:href="@{/api/files/download/{fileName}(fileName=${candidat.cv})}" target="_blank">üì• T√©l√©charger</a>
                <br/>
                <small>S√©lectionnez un nouveau fichier pour remplacer le CV/document existant.</small>
            </div>
            
            <!-- Onglets pour choisir le type de fichier -->
            <div class="file-type-tabs">
                <div class="file-type-tab active" onclick="switchFileType('document')">üìÑ Document (CV)</div>
                <div class="file-type-tab" onclick="switchFileType('image')">üñºÔ∏è Image (Portfolio)</div>
            </div>
            
            <!-- Upload de document -->
            <div id="document-upload" class="file-type-content active">
                <div class="file-upload">
                    <input type="file" id="cvFile" name="cvFile" 
                           accept=".pdf,.doc,.docx,.txt,.rtf" 
                           onchange="handleFileSelect(this, 'document')"/>
                    
                    <div class="file-info" id="documentFileInfo" style="display: none;">
                        <span id="documentFileName"></span> - <span id="documentFileSize"></span>
                    </div>
                    
                    <small>üìÑ Formats accept√©s : PDF, DOC, DOCX, TXT, RTF. Taille maximum : 10MB</small>
                </div>
            </div>
            
            <!-- Upload d'image -->
            <div id="image-upload" class="file-type-content">
                <div class="file-upload">
                    <input type="file" id="imageFile" name="cvFile" 
                           accept=".jpg,.jpeg,.png,.gif,.bmp,.webp" 
                           onchange="handleFileSelect(this, 'image')"/>
                    
                    <div class="file-info" id="imageFileInfo" style="display: none;">
                        <span id="imageFileName"></span> - <span id="imageFileSize"></span>
                        <br/>
                        <img id="imagePreview" style="max-width: 200px; max-height: 200px; margin-top: 10px; border: 1px solid #ddd; border-radius: 4px;" />
                    </div>
                    
                    <small>üñºÔ∏è Formats accept√©s : JPG, JPEG, PNG, GIF, BMP, WEBP. Taille maximum : 5MB</small>
                </div>
            </div>
        </div>

        <button type="submit" class="btn btn-success" id="submit-btn">Enregistrer ma candidature</button>
        <a th:href="@{/annonces}" class="btn btn-secondary">Retour aux annonces</a>
        
        <!-- Si on vient d'une annonce sp√©cifique, proposer un lien de retour -->
        <a th:if="${selectedAnnonce != null}" th:href="@{/annonces/{id}(id=${selectedAnnonce.id})}" class="btn btn-secondary">Retour √† l'annonce</a>
    </form>

    <script>
        // Variables globales pour les crit√®res
        let currentCriteria = null;
        let currentFileType = 'document';

        // Gestion des onglets de type de fichier
        function switchFileType(type) {
            currentFileType = type;
            
            // Mettre √† jour les onglets
            document.querySelectorAll('.file-type-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.file-type-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(type + '-upload').classList.add('active');
            
            // R√©initialiser les champs de fichier
            document.getElementById('cvFile').value = '';
            document.getElementById('imageFile').value = '';
            hideFileInfo('document');
            hideFileInfo('image');
        }

        // Gestion de la s√©lection de fichier
        function handleFileSelect(input, type) {
            const file = input.files[0];
            const fileInfo = document.getElementById(type + 'FileInfo');
            const fileName = document.getElementById(type + 'FileName');
            const fileSize = document.getElementById(type + 'FileSize');

            if (file) {
                // V√©rifier la taille du fichier
                const maxSize = type === 'image' ? 5 * 1024 * 1024 : 10 * 1024 * 1024;
                if (file.size > maxSize) {
                    const maxSizeText = type === 'image' ? '5MB' : '10MB';
                    alert(`Fichier trop volumineux. Taille maximum : ${maxSizeText}`);
                    input.value = '';
                    fileInfo.style.display = 'none';
                    return;
                }

                // V√©rifier le type de fichier
                const validTypes = type === 'image' 
                    ? ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/bmp', 'image/webp']
                    : ['application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', 'text/plain', 'application/rtf'];

                if (!validTypes.includes(file.type)) {
                    const allowedText = type === 'image' ? 'JPG, JPEG, PNG, GIF, BMP, WEBP' : 'PDF, DOC, DOCX, TXT, RTF';
                    alert(`Type de fichier non support√©. Utilisez : ${allowedText}`);
                    input.value = '';
                    fileInfo.style.display = 'none';
                    return;
                }

                // Afficher les informations du fichier
                fileName.textContent = file.name;
                fileSize.textContent = formatFileSize(file.size);
                fileInfo.style.display = 'block';

                // Aper√ßu pour les images
                if (type === 'image') {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        document.getElementById('imagePreview').src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            } else {
                fileInfo.style.display = 'none';
            }
        }

        function hideFileInfo(type) {
            document.getElementById(type + 'FileInfo').style.display = 'none';
        }

        // Formatage de la taille du fichier
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Fonctions existantes pour les crit√®res...
        function showAnnonceCriteria() {
            const annonceSelect = document.getElementById('annonce');
            const selectedOption = annonceSelect.options[annonceSelect.selectedIndex];
            const criteriaInfo = document.getElementById('criteria-info');
            const criteriaList = document.getElementById('criteria-list');

            if (selectedOption.value && selectedOption.value !== '') {
                const experience = selectedOption.dataset.experience;
                const age = selectedOption.dataset.age;
                const diplome = selectedOption.dataset.diplome;
                const filiere = selectedOption.dataset.filiere;

                currentCriteria = {
                    experience: experience ? parseInt(experience) : null,
                    age: age ? parseInt(age) : null,
                    diplome: diplome || null,
                    filiere: filiere || null
                };

                criteriaList.innerHTML = '';
                if (experience) {
                    criteriaList.innerHTML += `<li>Exp√©rience minimum : <strong>${experience} ans</strong></li>`;
                }
                if (age) {
                    criteriaList.innerHTML += `<li>√Çge maximum : <strong>${age} ans</strong></li>`;
                }
                if (diplome) {
                    criteriaList.innerHTML += `<li>Dipl√¥me : <strong>${diplome}</strong></li>`;
                }
                if (filiere) {
                    criteriaList.innerHTML += `<li>Fili√®re : <strong>${filiere}</strong></li>`;
                }

                criteriaInfo.style.display = 'block';
                checkEligibility();
            } else {
                criteriaInfo.style.display = 'none';
                currentCriteria = null;
                hideEligibilityWarning();
            }
        }

        function checkEligibility() {
            if (!currentCriteria) return;

            const experienceInput = document.getElementById('anneesExperience');
            const ageInput = document.getElementById('age');
            const warningDiv = document.getElementById('eligibility-warning');
            const messageSpan = document.getElementById('eligibility-message');
            const submitBtn = document.getElementById('submit-btn');

            let warnings = [];

            if (currentCriteria.experience && experienceInput.value) {
                const candidatExperience = parseInt(experienceInput.value);
                if (candidatExperience < currentCriteria.experience) {
                    warnings.push(`Exp√©rience insuffisante (${candidatExperience} ans < ${currentCriteria.experience} ans requis)`);
                }
            }

            if (currentCriteria.age && ageInput.value) {
                const candidatAge = parseInt(ageInput.value);
                if (candidatAge > currentCriteria.age) {
                    warnings.push(`√Çge non conforme (${candidatAge} ans > ${currentCriteria.age} ans maximum)`);
                }
            }

            if (warnings.length > 0) {
                messageSpan.innerHTML = 'Vous ne semblez pas r√©pondre aux crit√®res : ' + warnings.join(', ');
                warningDiv.style.display = 'block';
                submitBtn.style.backgroundColor = '#dc3545';
                submitBtn.textContent = 'Postuler quand m√™me (non √©ligible)';
            } else {
                hideEligibilityWarning();
            }
        }

        function hideEligibilityWarning() {
            const warningDiv = document.getElementById('eligibility-warning');
            const submitBtn = document.getElementById('submit-btn');
            
            warningDiv.style.display = 'none';
            submitBtn.style.backgroundColor = '#28a745';
            submitBtn.textContent = 'Enregistrer ma candidature';
        }

        // Initialisation au chargement de la page
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('nom').focus();
            
            const annonceSelect = document.getElementById('annonce');
            if (annonceSelect && annonceSelect.value) {
                showAnnonceCriteria();
            }
        });
    </script>
</body>
</html>