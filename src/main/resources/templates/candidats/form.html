<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <title th:text="${candidat.id == null ? 'Postuler √† une offre' : 'Modifier ma candidature'}"></title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root{
      --bg:#f5f7fa; --text:#2c3e50; --sub:#4b5a6a;
      --card:#ffffff; --line:#e6ecf2;
      --primary:#3498db; --primary-d:#2980b9;
      --accent:#2ecc71; --accent-d:#27ae60;
      --danger:#e74c3c; --danger-d:#c0392b;
      --muted:#8aa0b2;
    }
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      line-height: 1.6;
      background: var(--bg);
      color: var(--text);
    }

    /* ===== HERO (m√™me que annonces) ===== */
    .hero {
      width: 100%;
      min-height: 240px;
      background: linear-gradient(to bottom, rgba(0,0,0,.35), rgba(0,0,0,.35)),
                  url('/images/.jpg') center/cover no-repeat;
      display: flex; align-items: center; justify-content: center;
      text-align: center; color: #fff;
      text-shadow: 0 3px 12px rgba(0,0,0,.45);
      padding: 32px 20px;
    }
    .hero h1 { font-size: 34px; font-weight: 700; }
    .hero p  { margin-top: 8px; font-size: 15px; opacity: .95; }

    /* ===== NAV (m√™me style) ===== */
    nav {
      background: #1f2b38;
      display: flex; justify-content: center; gap: 36px;
      padding: 12px 16px;
    }
    nav a {
      color: #ecf0f1; text-decoration: none; font-weight: 500;
      padding: 6px 8px; border-radius: 6px; transition: background .25s, color .25s;
    }
    nav a:hover { background: #2b3b4f; color: #1abc9c; }

    /* ===== CONTAINER / CARDS ===== */
    .container { max-width: 1000px; margin: 28px auto; padding: 0 20px; }
    .card{
      background: var(--card); border:1px solid var(--line); border-radius:14px; padding:22px;
      box-shadow:0 6px 16px rgba(0,0,0,.06); margin-bottom:18px;
    }
    .title { text-align:center; margin-bottom:10px }
    .title h2{
      display:inline-block; padding-bottom:6px; border-bottom:2px solid var(--primary);
      font-size: 24px;
    }

    /* Info annonce s√©lectionn√©e */
    .selected-annonce{
      background:#eef6ff; border:1px solid #d7e7ff; border-left:4px solid var(--primary);
      padding:16px; border-radius:10px;
    }
    .grid-2{ display:grid; grid-template-columns:1fr 1fr; gap:18px }
    @media(max-width:780px){ .grid-2{ grid-template-columns:1fr } }

    /* Formulaire */
    .form-group{ display:flex; flex-direction:column; gap:8px; margin-bottom:14px }
    label{ font-weight:700; color:#243447; font-size:14px }
    input[type="text"], input[type="email"], input[type="tel"], input[type="number"],
    textarea, select, input[type="file"]{
      width:100%; padding:12px; border:1px solid #d7dde5; border-radius:10px; font-size:14px; background:#fff;
      transition:border-color .2s, box-shadow .2s;
    }
    textarea{ min-height:120px; resize:vertical }
    input:focus, select:focus, textarea:focus{
      border-color:#8ac4fb; box-shadow:0 0 0 4px rgba(52,152,219,.15); outline:none;
    }
    select{
      appearance:none;
      background-image:linear-gradient(45deg, transparent 50%, #8aa0b2 50%), linear-gradient(135deg, #8aa0b2 50%, transparent 50%);
      background-position: calc(100% - 18px) calc(1em + 2px), calc(100% - 13px) calc(1em + 2px);
      background-size:5px 5px,5px 5px; background-repeat:no-repeat;
    }
    .help{ font-size:12px; color:#6f7f90 }
    .section-title{ font-size:16px; font-weight:800; margin:8px 0 12px; color:#243447 }

    /* Alerts */
    .alert{ padding:14px; border-radius:10px; border:1px solid; margin-bottom:14px }
    .alert-error{ background:#fdecea; color:#a12622; border-color:#f3c3c0 }
    .alert-success{ background:#eafaf1; color:#1b7f45; border-color:#c9eedc }
    .alert-warning{ background:#fff8e6; color:#856404; border-color:#ffeaa7 }
    .criteria-info{
      background:#f5fbff; border:1px dashed #cfe7ff; color:#0c5460;
      padding:10px; border-radius:10px; margin-top:10px; font-size:.95em;
    }
    .eligibility-warning{
      background:#fff8e6; color:#856404; border:1px solid #ffeaa7; padding:14px; border-radius:10px; margin:14px 0;
    }

    /* File tabs (m√™me esprit que le th√®me) */
    .file-type-tabs{ display:flex; gap:6px; margin-bottom:10px; flex-wrap:wrap }
    .file-type-tab{
      padding:8px 12px; background:#fff; border:1px solid var(--line); cursor:pointer; border-radius:10px;
      font-weight:700; font-size:13px; color:#41607a;
    }
    .file-type-tab.active{ background:var(--primary); color:#fff; border-color:var(--primary) }
    .file-type-content{ display:none }
    .file-type-content.active{ display:block }
    .file-info{
      margin-top:10px; padding:10px; background:#f8fbff; border:1px dashed #cfe2f7; border-radius:10px; font-size:.92em
    }
    .current-cv{
      background:#eafaf1; color:#1b7f45; border:1px solid #c9eedc; padding:10px; border-radius:10px; margin-bottom:10px
    }

    /* Actions */
    .actions{ margin-top:8px; display:flex; gap:12px; flex-wrap:wrap; align-items:center }
    .btn{
      display:inline-block; padding:12px 18px; border-radius:10px; font-weight:800; font-size:14px;
      text-decoration:none; border:1px solid transparent; transition:transform .2s, box-shadow .2s, background .2s, border-color .2s
    }
    .btn-success{ background:var(--accent); color:#fff; }
    .btn-success:hover{ background:var(--accent-d); transform:translateY(-1px); box-shadow:0 8px 16px rgba(46,204,113,.2) }
    .btn-secondary{ background:#fff; color:var(--primary); border:1px solid #cfe2f7 }
    .btn-secondary:hover{ background:#f3f8ff; border-color:#b7d5f6 }
    .link{ color:var(--primary); text-decoration:none }
    .link:hover{ color:var(--primary-d) }

    /* Footer */
    footer { text-align: center; padding: 18px; color: #7f8c8d; background: #f0f3f6; margin-top: 32px; }
  </style>
</head>
<body>

  <!-- HERO -->
  <section class="hero">
    <div>
      <h1 th:text="${candidat.id == null ? 'Postuler √† une offre' : 'Modifier ma candidature'}"></h1>
      <p th:if="${selectedAnnonce}">
        Vous postulez pour <b th:text="${selectedAnnonce.profil}">Poste</b>.
      </p>
      <p th:if="${selectedAnnonce == null}">Choisissez une offre puis compl√©tez votre candidature.</p>
    </div>
  </section>

  <!-- NAV -->
  <nav>
    <a th:href="@{/annonces}">Annonces</a>
    <a th:href="@{/annonces}#apropos">√Ä propos</a>
    <a th:href="@{/annonces}#contact">Contact</a>
  </nav>

  <!-- CONTENU -->
  <div class="container">

    <!-- Messages -->
    <div th:if="${error}" class="alert" th:classappend="${notEligible} ? 'alert-warning' : 'alert-error'" th:utext="${error}"></div>
    <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>

    <!-- Annonce s√©lectionn√©e -->
    <div th:if="${selectedAnnonce}" class="card selected-annonce" style="margin-top:-2px;">
      <div class="grid-2">
        <div><b>Poste :</b> <span th:text="${selectedAnnonce.profil}"></span></div>
        <div><b>Publi√© le :</b> <span th:text="${#temporals.format(selectedAnnonce.datePublication, 'dd/MM/yyyy')}">--/--/----</span></div>
        <div style="grid-column:1/-1; margin-top:6px;"><b>Description :</b> <span th:text="${selectedAnnonce.description}"></span></div>
      </div>
    </div>

    <!-- Formulaire -->
    <div class="card">
      <div class="title"><h2 th:text="${candidat.id == null ? 'Formulaire de candidature' : 'Mettre √† jour ma candidature'}"></h2></div>

      <form th:action="@{/candidats/client/postuler}" method="post" th:object="${candidat}" enctype="multipart/form-data">
        <input type="hidden" th:field="*{id}" />

        <!-- S√©lection d‚Äôannonce si non pr√©-s√©lectionn√©e -->
        <div class="form-group" th:if="${selectedAnnonce == null}">
          <label for="annonce">Annonce <span style="color:#e74c3c">*</span></label>
          <select name="annonce.id" id="annonce" required onchange="showAnnonceCriteria()">
            <option value="">-- S√©lectionner une annonce --</option>
            <option th:each="a : ${annonces}"
                    th:value="${a.id}"
                    th:selected="${selectedAnnonceId != null and selectedAnnonceId == a.id}"
                    th:text="${a.profil + ' - ' + a.description}"
                    th:data-experience="${a.critereRech != null ? a.critereRech.anneesExperience : ''}"
                    th:data-age="${a.critereRech != null ? a.critereRech.age : ''}"
                    th:data-diplome="${a.critereRech != null and a.critereRech.diplome != null ? a.critereRech.diplome.nomDiplome : ''}"
                    th:data-filiere="${a.critereRech != null and a.critereRech.filiere != null ? a.critereRech.filiere.nomFiliere : ''}">
            </option>
          </select>

          <!-- Crit√®res dynamiques -->
          <div id="criteria-info" class="criteria-info" style="display:none;">
            <strong>üìã Crit√®res requis pour cette annonce :</strong>
            <ul id="criteria-list" style="margin-left:18px;"></ul>
          </div>
        </div>

        <!-- Champ cach√© si annonce d√©j√† choisie -->
        <input type="hidden" name="annonce.id" th:value="${selectedAnnonce != null ? selectedAnnonce.id : selectedAnnonceId}" th:if="${selectedAnnonce != null or selectedAnnonceId != null}"/>

        <!-- Infos perso -->
        <div class="section-title">Vos informations</div>
        <div class="grid-2">
          <div class="form-group">
            <label for="nom">Nom <span style="color:#e74c3c">*</span></label>
            <input type="text" th:field="*{nom}" id="nom" required maxlength="40"/>
          </div>
          <div class="form-group">
            <label for="prenom">Pr√©nom <span style="color:#e74c3c">*</span></label>
            <input type="text" th:field="*{prenom}" id="prenom" required maxlength="40"/>
          </div>
        </div>

        <div class="grid-2">
          <div class="form-group">
            <label for="email">Email <span style="color:#e74c3c">*</span></label>
            <input type="email" th:field="*{email}" id="email" required maxlength="40"/>
            <div class="help">Nous vous contacterons √† cette adresse.</div>
          </div>
          <div class="form-group">
            <label for="age">√Çge <span style="color:#e74c3c">*</span></label>
            <input type="number" th:field="*{age}" id="age" required min="16" max="70" onchange="checkEligibility()"/>
          </div>
        </div>

        <div class="grid-2">
          <div class="form-group">
            <label for="genre">Genre <span style="color:#e74c3c">*</span></label>
            <select th:field="*{genre}" id="genre" required>
              <option value="">-- S√©lectionner --</option>
              <option value="1">Homme</option>
              <option value="2">Femme</option>
            </select>
          </div>

          <div class="form-group">
            <label for="diplome">Dipl√¥me <span style="color:#e74c3c">*</span></label>
            <select th:field="*{diplome.id}" id="diplome" required>
              <option value="">-- S√©lectionner un dipl√¥me --</option>
              <option th:each="d : ${diplomes}" th:value="${d.id}" th:text="${d.nomDiplome}"></option>
            </select>
          </div>
        </div>

        <div class="grid-2">
          <div class="form-group">
            <label for="adresse">Adresse</label>
            <input type="text" th:field="*{adresse}" id="adresse" maxlength="60"/>
          </div>
          <div class="form-group">
            <label for="anneesExperience">Ann√©es d'exp√©rience <span style="color:#e74c3c">*</span></label>
            <input type="number" th:field="*{anneesExperience}" id="anneesExperience" required min="0" max="50" onchange="checkEligibility()"/>
          </div>
        </div>

        <!-- Alerte √©ligibilit√© -->
        <div id="eligibility-warning" class="eligibility-warning" style="display:none;">
          <strong>‚ö†Ô∏è Attention :</strong> <span id="eligibility-message"></span>
        </div>

        <div class="form-group">
          <label for="lettreMotivation">Lettre de motivation</label>
          <textarea th:field="*{lettreMotivation}" id="lettreMotivation" maxlength="1200" placeholder="Expliquez pourquoi vous √™tes la/le candidat(e) id√©al(e)‚Ä¶"></textarea>
        </div>

        <!-- Fichiers -->
        <div class="section-title">CV / Portfolio</div>

        <div th:if="${candidat.cv != null and not #strings.isEmpty(candidat.cv)}" class="current-cv">
          üìÑ CV actuel : <strong th:text="${candidat.cv}"></strong><br/>
          <a th:href="@{/api/files/download/{fileName}(fileName=${candidat.cv})}" target="_blank" class="link">üì• T√©l√©charger</a><br/>
          <small>S√©lectionnez un nouveau fichier pour remplacer l‚Äôactuel.</small>
        </div>

        <div class="file-type-tabs">
          <div class="file-type-tab active" onclick="switchFileType(event,'document')">üìÑ Document (CV)</div>
          <div class="file-type-tab" onclick="switchFileType(event,'image')">üñºÔ∏è Image (Portfolio)</div>
        </div>

        <!-- Upload Document -->
        <div id="document-upload" class="file-type-content active">
          <div class="file-upload">
            <input type="file" id="cvFile" name="cvFile" accept=".pdf,.doc,.docx,.txt,.rtf" onchange="handleFileSelect(this,'document')"/>
            <div class="file-info" id="documentFileInfo" style="display:none;">
              <span id="documentFileName"></span> ‚Äî <span id="documentFileSize"></span>
            </div>
            <small>Formats accept√©s : PDF, DOC, DOCX, TXT, RTF. Taille max : 10 Mo</small>
          </div>
        </div>

        <!-- Upload Image -->
        <div id="image-upload" class="file-type-content">
          <div class="file-upload">
            <input type="file" id="imageFile" name="cvFile" accept=".jpg,.jpeg,.png,.gif,.bmp,.webp" onchange="handleFileSelect(this,'image')"/>
            <div class="file-info" id="imageFileInfo" style="display:none;">
              <span id="imageFileName"></span> ‚Äî <span id="imageFileSize"></span><br/>
              <img id="imagePreview" style="max-width:200px; max-height:200px; margin-top:10px; border:1px solid #ddd; border-radius:8px;" />
            </div>
            <small>Formats accept√©s : JPG, JPEG, PNG, GIF, BMP, WEBP. Taille max : 5 Mo</small>
          </div>
        </div>

        <!-- Actions -->
        <div class="actions">
          <button type="submit" class="btn btn-success" id="submit-btn">Enregistrer ma candidature</button>
          <a th:href="@{/annonces}" class="btn btn-secondary">‚Üê Retour aux annonces</a>
          <a th:if="${selectedAnnonce != null}" th:href="@{/annonces/{id}(id=${selectedAnnonce.id})}" class="btn btn-secondary">‚Üê Retour √† l‚Äôannonce</a>
        </div>
      </form>
    </div>
  </div>

  <footer>¬© 2025 Entreprise de Recrutement RH ‚Äî Tous droits r√©serv√©s.</footer>

  <script>
    // Crit√®res (pour le warning)
    let currentCriteria = null;

    function switchFileType(e, type){
      document.querySelectorAll('.file-type-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.file-type-content').forEach(c => c.classList.remove('active'));
      e.target.classList.add('active');
      document.getElementById(type + '-upload').classList.add('active');

      const cv = document.getElementById('cvFile');
      const img = document.getElementById('imageFile');
      if (cv) cv.value = '';
      if (img) img.value = '';
      hideFileInfo('document'); hideFileInfo('image');
    }

    function handleFileSelect(input, type){
      const file = input.files[0];
      const infoBox = document.getElementById(type + 'FileInfo');
      const nameEl  = document.getElementById(type + 'FileName');
      const sizeEl  = document.getElementById(type + 'FileSize');

      if (!file){ if(infoBox) infoBox.style.display='none'; return; }

      const maxSize = (type === 'image') ? 5 * 1024 * 1024 : 10 * 1024 * 1024;
      if (file.size > maxSize){
        alert('Fichier trop volumineux. Max ' + (type==='image' ? '5' : '10') + ' Mo');
        input.value = '';
        infoBox.style.display='none';
        return;
      }

      const validTypes = (type === 'image')
        ? ['image/jpeg','image/jpg','image/png','image/gif','image/bmp','image/webp']
        : ['application/pdf','application/msword','application/vnd.openxmlformats-officedocument.wordprocessingml.document','text/plain','application/rtf'];

      if (!validTypes.includes(file.type)){
        alert('Type de fichier non support√©.');
        input.value = '';
        infoBox.style.display='none';
        return;
      }

      nameEl.textContent = file.name;
      sizeEl.textContent = formatFileSize(file.size);
      infoBox.style.display = 'block';

      if (type === 'image'){
        const reader = new FileReader();
        reader.onload = e => { document.getElementById('imagePreview').src = e.target.result; };
        reader.readAsDataURL(file);
      }
    }

    function hideFileInfo(type){
      const box = document.getElementById(type + 'FileInfo');
      if (box) box.style.display = 'none';
    }

    function formatFileSize(bytes){
      if (!bytes) return '0 B';
      const k=1024, units=['B','KB','MB','GB']; const i=Math.floor(Math.log(bytes)/Math.log(k));
      return (bytes/Math.pow(k,i)).toFixed(2)+' '+units[i];
    }

    function showAnnonceCriteria(){
      const sel = document.getElementById('annonce');
      if (!sel) return;
      const opt = sel.options[sel.selectedIndex];
      const info = document.getElementById('criteria-info');
      const list = document.getElementById('criteria-list');

      if (opt && opt.value){
        const experience = opt.dataset.experience;
        const age       = opt.dataset.age;
        const diplome   = opt.dataset.diplome;
        const filiere   = opt.dataset.filiere;

        currentCriteria = {
          experience: experience ? parseInt(experience) : null,
          age: age ? parseInt(age) : null,
          diplome: diplome || null,
          filiere: filiere || null
        };

        list.innerHTML = '';
        if (experience) list.innerHTML += `<li>Exp√©rience minimum : <strong>${experience} ans</strong></li>`;
        if (age)        list.innerHTML += `<li>√Çge maximum : <strong>${age} ans</strong></li>`;
        if (diplome)    list.innerHTML += `<li>Dipl√¥me : <strong>${diplome}</strong></li>`;
        if (filiere)    list.innerHTML += `<li>Fili√®re : <strong>${filiere}</strong></li>`;

        info.style.display = 'block';
        checkEligibility();
      } else {
        info.style.display = 'none';
        currentCriteria = null;
        hideEligibilityWarning();
      }
    }

    function checkEligibility(){
      if (!currentCriteria) return;
      const expEl = document.getElementById('anneesExperience');
      const ageEl = document.getElementById('age');
      const warn  = document.getElementById('eligibility-warning');
      const msg   = document.getElementById('eligibility-message');
      const submit= document.getElementById('submit-btn');

      let warnings = [];
      if (currentCriteria.experience != null && expEl.value){
        const ce = parseInt(expEl.value);
        if (ce < currentCriteria.experience) warnings.push(`Exp√©rience insuffisante (${ce} &lt; ${currentCriteria.experience})`);
      }
      if (currentCriteria.age != null && ageEl.value){
        const ca = parseInt(ageEl.value);
        if (ca > currentCriteria.age) warnings.push(`√Çge non conforme (${ca} &gt; ${currentCriteria.age})`);
      }

      if (warnings.length){
        msg.innerHTML = 'Vous ne semblez pas r√©pondre aux crit√®res : ' + warnings.join(', ');
        warn.style.display = 'block';
        submit.style.backgroundColor = '#dc3545';
        submit.textContent = 'Postuler quand m√™me (non √©ligible)';
      }else{
        hideEligibilityWarning();
      }
    }

    function hideEligibilityWarning(){
      const warn = document.getElementById('eligibility-warning');
      const submit = document.getElementById('submit-btn');
      warn.style.display = 'none';
      submit.style.backgroundColor = 'var(--accent)';
      submit.textContent = 'Enregistrer ma candidature';
    }

    document.addEventListener('DOMContentLoaded', function(){
      const nom = document.getElementById('nom'); if (nom) nom.focus();
      const sel = document.getElementById('annonce');
      if (sel && sel.value) showAnnonceCriteria();
    });
  </script>
</body>
</html>
