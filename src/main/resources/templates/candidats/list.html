<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <title>Liste des candidats</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#f5f7fa; --text:#2c3e50; --sub:#4b5a6a;
      --card:#ffffff; --line:#e6ecf2;
      --primary:#3498db; --primary-d:#2980b9;
      --accent:#2ecc71; --accent-d:#27ae60;
      --danger:#e74c3c; --danger-d:#c0392b;
      --muted:#8aa0b2;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:'Segoe UI',Arial,sans-serif; color:var(--text);
      background:var(--bg); padding:22px; max-width:1200px; margin:0 auto;
      line-height:1.6;
    }

    /* ===== Page header ===== */
    .page-header{
      background:linear-gradient(135deg, rgba(52,152,219,.12), rgba(46,204,113,.10));
      border:1px solid var(--line); border-radius:14px; padding:18px 20px; margin-bottom:18px;
      display:flex; align-items:center; justify-content:space-between; gap:16px; flex-wrap:wrap;
    }
    .page-title{ display:flex; flex-direction:column; gap:6px }
    .page-title h1{ font-size:22px; letter-spacing:.2px }
    .subtitle{ color:var(--sub); font-size:13px }
    .stats{ display:flex; gap:10px; align-items:center; flex-wrap:wrap }
    .pill{
      background:#eef6ff; color:#1d6fdc; border:1px solid #d7e7ff;
      padding:6px 12px; border-radius:999px; font-weight:800; font-size:12px;
    }

    /* ===== Cards / blocs ===== */
    .card{
      background:var(--card); border:1px solid var(--line); border-radius:14px; padding:18px;
      box-shadow:0 6px 16px rgba(0,0,0,.06); margin-bottom:18px;
    }
    .filters-grid{
      display:grid; grid-template-columns: repeat(4, 1fr); gap:14px;
    }
    @media(max-width:980px){ .filters-grid{ grid-template-columns:1fr 1fr } }
    @media(max-width:640px){ .filters-grid{ grid-template-columns:1fr } }

    .form-group{ display:flex; flex-direction:column; gap:6px }
    label{ font-weight:800; color:#243447; font-size:13px }
    input[type="text"], input[type="number"], select{
      padding:10px 12px; border:1px solid #d7dde5; border-radius:10px; background:#fff; font-size:14px;
      transition:border-color .2s, box-shadow .2s;
    }
    input:focus, select:focus{
      border-color:#8ac4fb; box-shadow:0 0 0 4px rgba(52,152,219,.15); outline:none;
    }
    select{
      appearance:none;
      background-image:linear-gradient(45deg, transparent 50%, #8aa0b2 50%), linear-gradient(135deg, #8aa0b2 50%, transparent 50%);
      background-position: calc(100% - 18px) calc(1em + 2px), calc(100% - 13px) calc(1em + 2px);
      background-size: 5px 5px, 5px 5px; background-repeat:no-repeat;
    }

    /* ===== Table ===== */
    .table-wrap{ background:var(--card); border:1px solid var(--line); border-radius:14px; overflow:hidden; }
    table{ width:100%; border-collapse:separate; border-spacing:0; }
    thead th{
      background:#1f2b38; color:#ecf0f1; text-align:left; position:sticky; top:0; z-index:1;
      font-weight:800; letter-spacing:.3px; padding:12px 14px;
    }
    tbody td{ padding:12px 14px; border-bottom:1px solid var(--line); color:#334353 }
    tbody tr:hover{ background:#f8fbff; }
    tbody tr:nth-child(even){ background:#fcfeff; }
    .col-actions a{ margin-right:8px; text-decoration:none; font-weight:800; }
    .small{ font-size:.92em; color:var(--muted) }
    .status-badge{
      display:inline-block; padding:4px 10px; border-radius:999px; font-weight:800; font-size:12px;
      background:#fff7ea; color:#b26a00; border:1px solid #ffe4b5;
    }

    /* Responsive table -> cartes */
    @media (max-width: 780px){
      thead{ display:none; }
      table, tbody, tr, td{ display:block; width:100%; }
      tr{ background:#fff; margin:12px 0; border:1px solid var(--line); border-radius:12px; }
      td{ border:0; border-bottom:1px dashed var(--line); }
      td:last-child{ border-bottom:0; }
      td[data-label]::before{
        content:attr(data-label) " : ";
        font-weight:800; color:var(--sub); display:block; margin-bottom:4px;
      }
      .col-actions{ padding-top:6px; }
    }

    /* ===== Boutons ===== */
    .btn{
      text-decoration:none; display:inline-block; padding:10px 12px; border-radius:10px; font-weight:800; font-size:13px;
      border:1px solid transparent; transition:background .2s, border-color .2s, transform .2s, box-shadow .2s; cursor:pointer;
    }
    .btn--primary{ background:var(--primary); color:#fff; }
    .btn--primary:hover{ background:var(--primary-d); transform:translateY(-1px); box-shadow:0 8px 16px rgba(41,128,185,.2); }
    .btn--ghost{ background:#fff; color:var(--primary); border-color:#cfe2f7; }
    .btn--ghost:hover{ background:#f3f8ff; border-color:#b7d5f6; }
    .btn--success{ background:var(--accent); color:#fff; }
    .btn--success:hover{ background:var(--accent-d); transform:translateY(-1px); box-shadow:0 8px 16px rgba(46,204,113,.2); }
    .btn--info{
      background:linear-gradient(135deg,#98c1d9,#3d5a80); color:#fff;
    }
    .btn--info:hover{ filter:brightness(.95); transform:translateY(-1px); box-shadow:0 8px 16px rgba(61,90,128,.2); }

    /* ===== Footer lien ===== */
    .footer-links{ margin-top:14px; }
    .link{ color:var(--primary); text-decoration:none; }
    .link:hover{ color:var(--primary-d); }
  </style>
</head>
<body>

  <!-- Header -->
  <div class="page-header">
    <div class="page-title">
      <h1>Liste des candidats</h1>
      <div class="subtitle">Filtrez, consultez le détail et planifiez des entretiens.</div>
    </div>
    <div class="stats">
      <span class="pill">Total : <b th:text="${#lists.size(candidats)}">0</b></span>
    </div>
  </div>

  <!-- Filtres -->
  <div class="card">
    <form class="filters-grid" th:action="@{/candidats}" method="get">
      <div class="form-group">
        <label for="filter-name">Nom / Prénom</label>
        <input type="text" id="filter-name" name="name" th:value="${filterName}" placeholder="Recherche…" />
      </div>

      <div class="form-group">
        <label for="filter-minscore">Note ≥</label>
        <input type="number" id="filter-minscore" step="0.1" name="minScore" th:value="${filterMinScore}" placeholder="ex : 70" />
      </div>

      <div class="form-group">
        <label for="filter-profil">Profil annonce</label>
        <input type="text" id="filter-profil" name="profil" th:value="${filterProfil}" placeholder="Recherche profil…" />
      </div>

      <div class="form-group">
        <label for="filter-propose">CV traite</label>
        <select id="filter-propose" name="propose">
          <option value="">— Tous —</option>
          <option th:value="yes" th:selected="${filterPropose=='yes'}">Oui</option>
          <option th:value="no" th:selected="${filterPropose=='no'}">Non</option>
        </select>
      </div>

      <!-- NOUVEAUX FILTRES -->
      <div class="form-group">
        <label for="filter-agemin">Âge min</label>
        <input type="number" id="filter-agemin" name="ageMin" min="16" max="120" th:value="${filterAgeMin}" placeholder="ex : 20" />
      </div>

      <div class="form-group">
        <label for="filter-agemax">Âge max</label>
        <input type="number" id="filter-agemax" name="ageMax" min="16" max="120" th:value="${filterAgeMax}" placeholder="ex : 40" />
      </div>

      <div class="form-group">
        <label for="filter-diplome">Diplôme</label>
        <select id="filter-diplome" name="diplomeId" th:value="${filterDiplome}">
          <option value="">— Tous —</option>
          <option th:each="d : ${diplomes}" th:value="${d.id}" th:text="${d.nomDiplome}"
                  th:selected="${filterDiplome != null and filterDiplome == d.id}"></option>
        </select>
      </div>
    </form>
  </div>

  <!-- Tableau -->
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Nom</th>
          <th>Prénom</th>
          <th>Note</th>
          <th>Noter entretien</th>
          <th>Annonce</th>
          <th style="width:220px">Actions</th>
          <th>Entretien / Statut</th>
        </tr>
      </thead>
      <tbody>
        <tr th:each="c : ${candidats}"
            th:attr="data-name=${c.nom != null ? c.nom.toLowerCase() : ''},
                     data-prenom=${c.prenom != null ? c.prenom.toLowerCase() : ''},
                     data-score=${scoresMap != null and scoresMap[c.id] != null ? scoresMap[c.id] : ''},
                     data-profil=${c.annonce != null ? c.annonce.profil : ''},
                     data-propose=${c.estPropose},
                     data-age=${c.age},
                     data-diplome=${c.diplome != null ? c.diplome.nomDiplome : ''}">
          <td th:text="${c.nom}" th:attr="data-label='Nom'">Nom</td>
          <td th:text="${c.prenom}" th:attr="data-label='Prénom'">Prénom</td>
          <td th:text="${scoresMap != null and scoresMap[c.id] != null ? scoresMap[c.id]/10 : '—'}" th:attr="data-label='Note'">—</td>
          <td th:attr="data-label='Noter entretien'">
            <div th:if="${niveauxMap == null or niveauxMap[c.id] == null}">
              <form th:action="@{/candidats/noter_entretien}" method="post" style="display:flex;gap:8px;align-items:center;">
                <input type="hidden" name="candidatId" th:value="${c.id}" />
                <input type="hidden" name="annonceId" th:value="${c.annonce != null ? c.annonce.id : 0}" />
                <input type="number" name="niveau" min="0" max="10" step="1" placeholder="Niv" style="width:68px" required />
                <button type="submit" class="btn btn--primary">Noter</button>
              </form>
            </div>
            <!-- Si un résultat existe, afficher le niveau (sans bouton) -->
            <div th:if="${niveauxMap != null and niveauxMap[c.id] != null}" class="small">
              Niveau : <b th:text="${niveauxMap[c.id]}">0</b>
            </div>
         </td>
          <td th:text="${c.annonce != null ? c.annonce.profil : '—'}" th:attr="data-label='Annonce'">Profil annonce</td>
          <td class="col-actions" th:attr="data-label='Actions'">
            <a th:href="@{/candidats/{id}(id=${c.id})}" class="btn btn--primary">Détail</a>
            <a th:href="@{/candidats/{id}(id=${c.id})}" class="btn btn--ghost">Voir</a>
          </td>
          <td th:attr="data-label='Entretien / Statut'">
            <div th:if="${c.estPropose == null or !c.estPropose}" style="display:inline-flex; gap:8px; flex-wrap:wrap;">
              <a th:href="@{'/candidats/planifier_entretien/' + ${c.id}}" class="btn btn--success">Planifier entretien</a>
              <a th:href="@{'/candidats/planifier_entretien_manual/' + ${c.id}}" class="btn btn--info">Planifier manuel</a>
            </div>
            <div th:if="${c.estPropose != null and c.estPropose}">
              <span th:if="${contratsMap != null and contratsMap[c.id] != null and contratsMap[c.id].dateDebut != null}"
                    th:text="${#temporals.format(contratsMap[c.id].dateDebut,'dd/MM/yyyy HH:mm')}">01/01/2025 09:00</span>
              <span th:if="${contratsMap == null or contratsMap[c.id] == null}" class="status-badge">Proposé</span>
            </div>
          </td>
        </tr>

        <tr th:if="${candidats == null or #lists.isEmpty(candidats)}">
          <td colspan="6" style="text-align:center; padding:22px; color:var(--sub);">
            Aucun candidat trouvé.
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <p class="footer-links">
    <a th:href="@{/}" class="link">← Accueil</a>
  </p>

  <script>
    (function(){
      const nameInput = document.getElementById('filter-name');
      const minScoreInput = document.getElementById('filter-minscore');
      const profilInput = document.getElementById('filter-profil');
      const proposeSelect = document.getElementById('filter-propose');

      // nouveaux éléments
      const ageMinInput = document.getElementById('filter-agemin');
      const ageMaxInput = document.getElementById('filter-agemax');
      const diplomeSelect = document.getElementById('filter-diplome');

      const tbody = document.querySelector('table tbody');
      let debounceTimer = null;

      function parseScore(v){
        const n = parseFloat(v);
        return isNaN(n) ? null : n;
      }

      function parseIntOrNull(v){
        const n = parseInt(v,10);
        return isNaN(n) ? null : n;
      }

      function filterRows(){
        const name = nameInput ? nameInput.value.trim().toLowerCase() : '';
        const minScore = minScoreInput ? parseScore(minScoreInput.value) : null;
        const profil = profilInput ? profilInput.value.trim().toLowerCase() : '';
        const propose = proposeSelect ? proposeSelect.value : '';

        const ageMin = ageMinInput ? parseIntOrNull(ageMinInput.value) : null;
        const ageMax = ageMaxInput ? parseIntOrNull(ageMaxInput.value) : null;
        const diplome = diplomeSelect ? (diplomeSelect.options[diplomeSelect.selectedIndex].text || '').trim().toLowerCase() : '';

        tbody.querySelectorAll('tr[data-name]').forEach(row => {
          const dName = (row.dataset.name || '').toLowerCase();
          const dPrenom = (row.dataset.prenom || '').toLowerCase();
          const dScore = row.dataset.score ? parseFloat(row.dataset.score) : null;
          const dProfil = row.dataset.profil || '';
          const dPropose = (row.dataset.propose === 'true');
          const dAge = row.dataset.age ? parseInt(row.dataset.age,10) : null;
          const dDiplome = (row.dataset.diplome || '').toLowerCase();

          let visible = true;
          if (name && !(dName.includes(name) || dPrenom.includes(name))) visible = false;
          if (minScore != null && (dScore == null || dScore < minScore)) visible = false;
          if (profil && !( (dProfil || '').toLowerCase().includes(profil) )) visible = false;
          if (propose === 'yes' && !dPropose) visible = false;
          if (propose === 'no' && dPropose) visible = false;

          // filtres Age
          if (ageMin != null && (dAge == null || dAge < ageMin)) visible = false;
          if (ageMax != null && (dAge == null || dAge > ageMax)) visible = false;

          // filtre Diplôme (compare texte visible de la liste)
          if (diplome && diplome !== '— tous —' && !(dDiplome.includes(diplome))) visible = false;

          row.style.display = visible ? '' : 'none';
        });
      }

      function scheduleFilter(){
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(filterRows, 150);
      }

      if (nameInput) nameInput.addEventListener('input', scheduleFilter);
      if (minScoreInput) minScoreInput.addEventListener('input', scheduleFilter);
      if (profilInput) profilInput.addEventListener('input', scheduleFilter);
      if (proposeSelect) proposeSelect.addEventListener('change', filterRows);

      // nouveaux listeners
      if (ageMinInput) ageMinInput.addEventListener('input', scheduleFilter);
      if (ageMaxInput) ageMaxInput.addEventListener('input', scheduleFilter);
      if (diplomeSelect) diplomeSelect.addEventListener('change', filterRows);

      document.addEventListener('DOMContentLoaded', filterRows);
    })();
  </script>
</body>
</html>
